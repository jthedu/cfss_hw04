---
title: "HW 4, pt. 2: Exploring World Bank Data"
author: "Julia Du"
output: github_document
---

## Load necessary libraries

```{r}
library(tidyverse)
library(ggthemes)
library(ggridges)
library(viridis)
library(forcats)

theme_set(theme_minimal())

#don't do iteration w/in function, dummy!!
mean_mtcars <- vector("numeric", length = ncol(mtcars))
for(i in seq_along(mtcars)) {
  output[[i]] <- mean(mtcars[[i]])
}

max_diamonds <- vector("numeric", length = ncol(diamonds))
for(i in seq_along(diamonds)) {
  output[[i]] <- max(diamonds[[i]])
}
```

## Write a function to import the data files

  I'm interested in the following four variables: 
    
    1. Population growth (annual %) = SP.POP.GROW
    2. Urban population growth (annual %) = SP.URB.GROW
    3. Population density (people per sq. km of land area) = EN.POP.DNST
    4. "Life expectancy at birth, total (years)" = SP.DYN.LE00.IN

```{r}
import_tidydata <- function(file_name) {
 path = "./data_world_bank/"  
 read_csv(paste0(path, file_name), skip = 4) %>%
   rename(country_name = `Country Name`, country_code = `Country Code`, indicator_name = `Indicator Name`, indicator_code = `Indicator Code`) %>%
   filter(indicator_code %in% c("SP.POP.GROW", "SP.URB.GROW", "EN.POP.DNST", "SP.DYN.LE00.IN")) %>%
   #selecting chosen 4 variables: population growth, urban population growth, population density, & life expectancy at birth. doing it here & not in final select of function so that function (theoretically) runs faster
   select(-c(country_code, indicator_name)) %>%
   pivot_longer(cols = `1960`:`2019`, names_to = "year", values_to = "values") %>%
   pivot_wider(names_from = indicator_code, values_from = values) %>%
   select(-X65)
}

#This is what I used to check my work while creating the function.
sampledfname <- "API_ABW_DS2_en_csv_v2_1226885.csv"
sampledf <- import_tidydata(sampledfname)
```

## Import the data

```{r, message = FALSE}
# used message = FALSE to avoid pages of same message saying it created a new column [X65], as seen above
masterdata <- list.files(path = "./data_world_bank/", pattern = "\\.csv$") %>% #could also write "*.csv"
map(import_tidydata) %>%
  reduce(rbind) %>%
    mutate(country_name = if_else(country_name == "Korea, Rep.", "South Korea", country_name)) 
#changing name of South Korea now to set up for later analysis
```

## Explore the data
# **East Asian countries** 
My initial analysis focuses on 3 East Asian countries: China, Japan, and South Korea.
```{r}
focus_data <- masterdata %>%
  filter(country_name %in% c("China", "Japan", "South Korea")) %>%
  rename(totalpopgrow = `SP.POP.GROW`, urbpopgrow = `SP.URB.GROW`, popdensity = `EN.POP.DNST`, life_expectancy = `SP.DYN.LE00.IN`)

focus_data %>%
  group_by(country_name) %>%
  drop_na(totalpopgrow:life_expectancy) %>%
  summarize(
    mean(totalpopgrow), mean(urbpopgrow), mean(popdensity), mean(life_expectancy)
    ) %>%
  kable(caption = "Averages of indicators across East Asian countries, from 1960-2020", col.names = c("Country", "Total population growth (%)", "Urban population growth (%)", "Population density (per sq. km)", "Life expectancy (yrs)"), digits = 2)
```

	For all 3 selected East Asian countries, the table shows the average values of the indicators of interest from 1960 to 2020. On average, China experienced more population growth – both total and urban – over the years. However, South Korea has the biggest average population density, nearly 4x China’s average over the years. Japan had the highest average life expectancy at birth, roughly 78 years, which is 10 years more than China’s average life expectancy.


# **3 geographical regions (9 total countries)** 
I started my analysis just focusing on the 3 East Asian countries above, but I realized I could look at *regions*. I focused on 3 geographical regions: East Asia (same as above), North America (Mexico, Canada, US), and Western Europe (France, Germany, UK). 
```{r}
#compare geographical regions
require(forcats)

e_asia <- c("China", "Japan", "South Korea")
n_ame <- c("Mexico", "Canada", "United States")
w_eur <- c("France", "Germany", "United Kingdom")

region_level <- c(e_asia, n_ame, w_eur)
  #"East Asia", "North America", "Western Europe")

regional_data <- masterdata %>%
  filter(country_name %in% c(e_asia, n_ame, w_eur)) %>%
  rename(totalpopgrow = `SP.POP.GROW`, urbpopgrow = `SP.URB.GROW`, popdensity = `EN.POP.DNST`, life_expectancy = `SP.DYN.LE00.IN`) %>%
  mutate(region = case_when(
    country_name %in% e_asia ~ "East Asia",
    country_name %in% n_ame ~ "North America",
    country_name %in% w_eur ~ "Western Europe"
  )) %>%
  mutate(country_name = factor(country_name, levels = region_level), country_name = fct_rev(country_name))

#table of mean indicators across region
regional_data %>%
  group_by(region) %>%
  drop_na(totalpopgrow:life_expectancy) %>%
  summarize(
    mean(totalpopgrow), mean(urbpopgrow), mean(popdensity), mean(life_expectancy)
    ) %>%
  kable(
    caption = "Averages of indicators across region, from 1960-2020", 
    col.names = c("Region", "Total population growth (%)", "Urban population growth (%)", "Population density (per sq. km)", "Life expectancy (yrs)"), 
    digits = 2)

# violinplot of life_expectancy - all countries
regional_data %>%
  ggplot(mapping = aes(x = country_name, y = life_expectancy, fill = region)) +
  geom_violin() +
  geom_boxplot(width=0.1, color="grey", alpha=0.2) +
    labs(title = "Life expectancy in selected countries, 1960-2020", x = "", y = "Life expectancy at birth (yrs)", caption = "Source: The World Bank", fill = "Region") +
  theme(legend.position = "bottom") +
  coord_flip()

#violin plot of regional life expectancy
ggplot(data = regional_data, mapping = aes(x = region, y = life_expectancy, fill = region)) +
  geom_violin() +
  geom_boxplot(width=0.1, color="grey", alpha=0.2) +
    labs(title = "Annual life expectancy in selected regions, 1960-2020", x = "", y = "Life expectancy at birth (yrs)", caption = "Source: The World Bank", fill = "Country") +
  scale_y_continuous(limits = c(40, 90)) +
  theme(legend.position = "none")

#ridged population density - all countries
ggplot(data = regional_data, mapping = aes(x = popdensity, y = country_name, fill = region)) +
  geom_density_ridges(alpha = 0.6) +
  scale_fill_viridis(discrete = TRUE) +
  scale_color_viridis(discrete = TRUE) +
    labs(title = "Population density in selected countries, 1960-2020", x = "Population density", y = "", caption = "Source: The World Bank", fill = "Country") +
  theme(legend.position = "none")

#ridged pop density - 
ggplot(data = regional_data, mapping = aes(x = popdensity, y = region, fill = region)) +
  geom_density_ridges(alpha = 0.6) +
  scale_fill_viridis(discrete = TRUE) +
  scale_color_viridis(discrete = TRUE) +
    labs(title = "Population density in selected regions, 1960-2020", x = "Population density", y = "", caption = "Source: The World Bank", fill = "Country") +
  theme(legend.position = "none")
```
``` {r}
#line graphs of 3 regions, tracking variables over time

regional_data %>%
  ggplot(mapping = aes(x = year, y = popdensity, color = fct_rev(country_name), group = country_name)) +
  geom_line() +
  facet_wrap(region ~ .)  +
  labs(title = "Annual population density, 1960-2020", subtitle = "In selected countries", x = "Year", y = "Population density (people per sq. km)", caption = "Source: The World Bank", color = "Country") +
  scale_x_discrete(breaks = seq(1960, 2020, by = 10)) +
  theme(legend.position = "bottom")
#E Asian countries clearly have higher pop densities, while N American countries have the lowest out of this batch. still see an increase for all countries, though Germany & Canada have stayed pretty constant over time

regional_data %>%
  ggplot(mapping = aes(x = year, y = totalpopgrow/100, color = fct_rev(country_name), group = country_name)) +
  geom_line() +
  facet_wrap(region ~ .)  +
  labs(title = "Annual total population growth, 1960-2020", subtitle = "In selected countries", x = "Year", y = "Total population growth", caption = "Source: The World Bank", color = "Country") +
  scale_x_discrete(breaks = seq(1960, 2020, by = 10)) +
  scale_y_continuous(labels = scales::percent) +
  theme(legend.position = "bottom")
#see a slowing in total population growth, but still positive for most part

regional_data %>%
  ggplot(mapping = aes(x = year, y = life_expectancy, color = fct_rev(country_name), group = country_name)) +
  geom_line() +
  facet_wrap(region ~ .)  +
  labs(title = "Life expectancy, 1960-2020", subtitle = "In selected countries", x = "Year", y = "Life expectancy, at birth (yrs)", caption = "Source: The World Bank", color = "Country") +
  scale_x_discrete(breaks = seq(1960, 2020, by = 10)) +
  theme(legend.position = "bottom")
# can see that Western Europe's life expectancies have roughly stayed together, whereas North American countries were slightly diverged (though getting closer now) and East Asian countries are even more divergent. In all regions here, we have seen an increase in life expectancy over time, with East Asian countries experiencing the most dramatic change (as China and South Korea started with noticeably lower expectancies). Today, we see roughly similar life expectancies, hovering around 80 yrs. Japan and South Korea have actually surpassed the North American and Western European countries, while China and Mexico lag behind.
#### add in insights from VIOLIN PLOT (compare medians, talk about skew & sample size/density)

ggplot(data = regional_data, mapping = aes(x = year)) +
  geom_line(mapping = aes(y = totalpopgrow/100, color = "Total population growth"), group = 1) +
  geom_line(mapping = aes(y = urbpopgrow/100, color = "Urban population growth"), group = 1) +
  facet_wrap(fct_rev(country_name) ~.) +
    labs(title = "Urban & Total Population Growth, 1960-2020", x = "Year", y = "Percent of annual population growth", caption = "Source: The World Bank", color = "Legend") +
  scale_x_discrete(breaks = seq(1960, 2020, by = 10)) +
  scale_y_continuous(labels = scales::percent) +
  theme(legend.position = "bottom")

```

## Session info

```{r}
devtools::session_info()
```


